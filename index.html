<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>pdf.js ローカル最小テスト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      margin: 8px;
    }
    h1{
      font-size: 18px;
      margin: 0 0 4px;
    }
    .info{
      font-size: 12px;
      color:#555;
      margin-bottom: 6px;
      line-height:1.4;
    }
    #log{
      margin-top: 8px;
      background:#000;
      color:#0f0;
      padding:4px;
      font-family: "Consolas","Menlo",monospace;
      font-size: 12px;
      height: 260px;
      overflow:auto;
      white-space: pre-wrap;
    }
    #pageCanvas{
      border:1px solid #ccc;
      margin-top:8px;
      max-width:100%;
      background:#fff;
    }
  </style>
</head>
<body>
  <h1>pdf.js ローカル最小テスト</h1>
  <div class="info">
    v2025.11.21-min / Edge95 file:// 想定<br>
    ① 同じフォルダに <code>pdf.min.js</code> を置く<br>
    ② 「ファイルの選択」で PDF を選び、1ページ目を読み込めるか確認
  </div>

  <div>
    PDFファイル選択：
    <input type="file" id="pdfFile" accept="application/pdf">
  </div>

  <canvas id="pageCanvas"></canvas>

  <div id="log"></div>

  <!-- [LIB] ローカルの pdf.min.js を読み込み -->
  <script src="pdf.min.js"></script>

  <script>
    //========================
    // ログ出力ユーティリティ
    //========================
    const logEl = document.getElementById("log");
    function log(msg){
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    //========================
    // pdf.js 初期化状況を確認
    //========================
    if (typeof pdfjsLib === "undefined") {
      log("ERROR: pdfjsLib が定義されていません。pdf.min.js の配置を確認してください。");
    } else {
      log(`OK: pdf.min.js 読み込み完了。pdfjsLib.version = ${pdfjsLib.version || "不明"}`);
      log(`location.protocol = ${location.protocol}（file:// 想定）`);
      log("備考: file:// なので worker は使わずに main thread で動作させます。");
    }

    //========================
    // ファイル選択イベント
    //========================
    document.getElementById("pdfFile").addEventListener("change", async (ev) => {
      const file = ev.target.files[0];
      if (!file) return;

      log("");
      log("--- PDF読み込み開始 ---");
      log(`ファイル名: ${file.name} / サイズ: ${file.size} bytes`);

      try {
        const arrayBuffer = await file.arrayBuffer();

        // ★ポイント★
        // ・workerSrc は一切設定しない
        // ・disableWorker:true だけ指定
        const loadingTask = pdfjsLib.getDocument({
          data: arrayBuffer,
          disableWorker: true
        });

        const pdf = await loadingTask.promise;
        log(`ページ数: ${pdf.numPages} ページ`);

        const page = await pdf.getPage(1);
        const viewport = page.getViewport({ scale: 1.2 });

        const canvas = document.getElementById("pageCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width  = viewport.width;
        canvas.height = viewport.height;

        const renderTask = page.render({
          canvasContext: ctx,
          viewport: viewport
        });
        await renderTask.promise;
        log("1ページ目の描画完了。");

        const textContent = await page.getTextContent();
        const text = textContent.items.map(it => it.str).join("");
        log("1ページ目のテキスト（先頭100文字）:");
        log(text.slice(0, 100) + (text.length > 100 ? "..." : ""));

        log("--- PDF読み込みテスト終了 ---");
      } catch (e) {
        console.error(e);
        log("ERROR: PDF読み込み中に例外が発生しました。");
        log(String(e));
      }
    });
  </script>
</body>
</html>