<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>納入台帳テキスト貼り付け → 請求書プレビュー</title>
  <style>
    body{
      font-family: "Meiryo", "Yu Gothic", sans-serif;
      margin:8px;
      font-size:13px;
    }
    h1{
      font-size:16px;
      margin:4px 0;
    }
    h2{
      font-size:14px;
      margin:6px 0 4px;
    }
    #input-area{
      margin-bottom:8px;
      border:1px solid #ccc;
      padding:6px;
    }
    #srcText{
      width:100%;
      height:120px;
      box-sizing:border-box;
      font-family: Consolas, "Courier New", monospace;
      font-size:12px;
    }
    #bulk-spec-area{
      margin:8px 0;
      border:1px solid #ccc;
      padding:6px;
    }
    #bulkSpecText{
      width:60%;
      box-sizing:border-box;
    }
    #preview-area{
      border:1px solid #ccc;
      padding:6px;
    }
    #headerPreview{
      margin-bottom:4px;
      line-height:1.4;
    }
    table{
      border-collapse:collapse;
      width:100%;
      font-size:12px;
    }
    th, td{
      border:1px solid #999;
      padding:2px 4px;
      white-space:nowrap;
      text-align:left;
    }
    th{
      background:#eee;
    }
    input.row-input{
      width:100%;
      box-sizing:border-box;
      border:none;
      padding:1px 2px;
      font-size:12px;
      font-family: inherit;
    }
    input.row-input:focus{
      outline:1px solid #66aaff;
      background:#f0f8ff;
    }
    .col-mark{
      font-size:10px;
      color:#d00;
      margin-left:3px;
    }
    .btn{
      font-size:12px;
      padding:2px 8px;
      margin:2px 2px 2px 0;
    }
    .note{
      font-size:11px;
      color:#666;
    }

    /* 印刷時は入力部分を隠し、プレビューだけ印刷 */
    @media print{
      #input-area, #bulk-spec-area{
        display:none;
      }
      body{
        margin:0;
      }
      #preview-area{
        border:none;
        margin:0;
        padding:4mm;
      }
    }
  </style>
</head>
<body>

<h1>納入台帳テキスト → 請求書プレビュー</h1>

<div id="input-area">
  <h2>① PDFテキスト貼り付け</h2>
  <p class="note">
    PDFを開き、<strong>Ctrl + A → Ctrl + C</strong> で全文コピーして、このテキストボックスに貼り付けてください。<br>
    入力内容は自動で解析され、下にプレビューが表示されます。
  </p>
  <textarea id="srcText"></textarea><br>
  <button id="btnPrint" class="btn">印刷</button>
</div>

<div id="bulk-spec-area">
  <h2>② 規格 一括入力</h2>
  <input type="text" id="bulkSpecText">
  <button id="btnBulkSpec" class="btn">一括入力</button>
  <span class="note">← ここに入力した規格が、全行の「規格」列にコピーされます。</span>
</div>

<div id="preview-area">
  <h2>③ プレビュー（請求書イメージ）</h2>
  <div id="headerPreview">
    年月分: -<br>
    納地: -<br>
    業者名: -
  </div>

  <table id="detailTable">
    <thead>
      <tr>
        <th style="width:40px;">No</th>
        <th>品名<span id="mark-name" class="col-mark"></span></th>
        <th>規格</th>
        <th style="width:70px;">数量<span id="mark-qty" class="col-mark"></span></th>
        <th style="width:80px;">単価<span id="mark-price" class="col-mark"></span></th>
        <th style="width:90px;">金額<span id="mark-amount" class="col-mark"></span></th>
      </tr>
    </thead>
    <tbody id="detailTbody">
      <!-- ここに行が生成される -->
    </tbody>
  </table>

  <div id="sumPreview" style="margin-top:6px; white-space:pre-line;">
[最終ページ集計]
課税対象額: -
消費税: -
合計: -
  </div>
</div>

<script>
  // ===== グローバル状態 =====
  var originalHeader = { ymd:'', place:'', vendor:'' };
  var originalRows = []; // [{no,name,spec,qty,price,amount}, ...]
  var originalSum  = { taxable:'', tax:'', total:'' };

  // ===== 初期化 =====
  (function(){
    var src = document.getElementById('srcText');
    src.oninput = function(){
      parseAndRender();
    };

    var btnBulk = document.getElementById('btnBulkSpec');
    btnBulk.onclick = function(){
      applyBulkSpec();
    };

    var btnPrint = document.getElementById('btnPrint');
    btnPrint.onclick = function(){
      window.print();
    };
  })();

  // ===== 解析してプレビュー更新 =====
  function parseAndRender(){
    var text = document.getElementById('srcText').value;
    if (!text) {
      clearPreview();
      return;
    }

    var lines = text.split(/\r\n|\r|\n/);
    var i;

    originalHeader = { ymd:'', place:'', vendor:'' };
    originalRows = [];
    originalSum  = { taxable:'', tax:'', total:'' };

    // ヘッダー＆明細＆集計を行単位でざっくり解析
    for (i = 0; i < lines.length; i++) {
      var line = trim(lines[i]);
      if (!line) continue;

      // 年月分（令和X年Y月）
      if (!originalHeader.ymd && line.indexOf('令和') !== -1 && line.indexOf('年') !== -1 && line.indexOf('月') !== -1) {
        var m = line.match(/令和\s*\d+\s*年\s*\d+\s*月/);
        if (m) {
          originalHeader.ymd = m[0].replace(/\s+/g, '');
        } else {
          originalHeader.ymd = line;
        }
        continue;
      }

      // 納地
      if (!originalHeader.place && (line.indexOf('納地') !== -1 || line.indexOf('納 地') !== -1)) {
        var p = line.replace(/.*納\s*地[:：]?\s*/, '');
        originalHeader.place = trim(p);
        continue;
      }

      // 業者名
      if (!originalHeader.vendor && (line.indexOf('業者名') !== -1 || line.indexOf('業 者 名') !== -1)) {
        var v = line.replace(/.*業\s*者\s*名[:：]?\s*/, '');
        originalHeader.vendor = trim(v);
        continue;
      }

      // 明細行（先頭4桁が数字）
      if (/^\d{4}\b/.test(line)) {
        var row = parseDetailLine(line);
        if (row) {
          originalRows.push(row);
        }
        continue;
      }

      // 最終ページ集計
      if (!originalSum.taxable && line.indexOf('課税対象額') !== -1) {
        originalSum.taxable = extractLastNumber(line);
        continue;
      }
      if (!originalSum.tax && line.indexOf('消費税') !== -1) {
        originalSum.tax = extractLastNumber(line);
        continue;
      }
      if (!originalSum.total && (line.indexOf('合計') !== -1 || line.indexOf('合　計') !== -1)) {
        originalSum.total = normalizeTotal(extractLastNumber(line));
        continue;
      }
    }

    renderPreview();
  }

  function trim(s){
    return s.replace(/^\s+|\s+$/g, '');
  }

  // 明細1行を解析
  function parseDetailLine(line){
    var no = line.substr(0, 4);
    var rest = trim(line.substr(4));

    // 数字トークンの抽出
    var numTokens = [];
    var re = /[0-9０-９,\.]+/g;
    var m;
    while ((m = re.exec(rest)) !== null) {
      numTokens.push({ text:m[0], index:m.index });
    }

    // 単価と金額がくっついているパターンを分割
    var i;
    var extraTokens = [];
    for (i = 0; i < numTokens.length; i++) {
      var t = numTokens[i].text;
      // 例: "85.0018,360.00" → "85.00" と "18,360.00"
      var m2 = t.match(/^(\d+\.\d{2})(\d{1,3}(?:,\d{3})*\.\d{2})$/);
      if (m2) {
        // 元の位置に2つ分を挿入
        extraTokens.push({
          index: numTokens[i].index,
          tokens: [
            { text:m2[1], index:numTokens[i].index },
            { text:m2[2], index:numTokens[i].index + m2[1].length }
          ]
        });
      }
    }
    // 分割適用
    if (extraTokens.length > 0) {
      var newTokens = [];
      var usedIndexes = {};
      for (i = 0; i < numTokens.length; i++) {
        var inserted = false;
        var j;
        for (j = 0; j < extraTokens.length; j++) {
          if (extraTokens[j].index === numTokens[i].index && !usedIndexes[i]) {
            newTokens.push(extraTokens[j].tokens[0]);
            newTokens.push(extraTokens[j].tokens[1]);
            inserted = true;
            usedIndexes[i] = true;
            break;
          }
        }
        if (!inserted) {
          newTokens.push(numTokens[i]);
        }
      }
      numTokens = newTokens;
    }

    if (numTokens.length < 2) {
      // 数字情報が少なすぎる場合はスキップ
      return null;
    }

    // 数字トークンのうち、末尾3つを [数量, 単価, 金額] とみなす（なければ空）
    var qtyText = "";
    var priceText = "";
    var amountText = "";

    var len = numTokens.length;
    if (len >= 3) {
      qtyText    = numTokens[len - 3].text;
      priceText  = numTokens[len - 2].text;
      amountText = numTokens[len - 1].text;
    } else if (len === 2) {
      qtyText    = "";
      priceText  = numTokens[0].text;
      amountText = numTokens[1].text;
    } else if (len === 1) {
      amtText = numTokens[0].text;
    }

    // 品名部分：先頭から数量トークンの位置の手前まで
    var namePartEnd = (len >= 3) ? numTokens[len - 3].index : rest.length;
    var nameText = trim(rest.substring(0, namePartEnd));

    return {
      no: no,
      name: nameText,
      spec: "",
      qty: qtyText,
      price: priceText,
      amount: amountText
    };
  }

  // 行から最後の数値っぽい部分を抜き出す
  function extractLastNumber(line){
    var re = /[0-9０-９,\.\\¥￥\-]+/g;
    var m;
    var last = "";
    while ((m = re.exec(line)) !== null) {
      last = m[0];
    }
    return trim(last);
  }

  // 合計用：¥ や \ や 末尾の - を削って整形
  function normalizeTotal(text){
    if (!text) return text;
    var t = text;
    t = t.replace(/[¥￥\\]/g, '');
    t = t.replace(/-+$/g, '');
    t = trim(t);
    return t;
  }

  // ===== プレビュー描画 =====
  function clearPreview(){
    document.getElementById('headerPreview').innerHTML =
      "年月分: -<br>納地: -<br>業者名: -";
    document.getElementById('detailTbody').innerHTML = "";
    document.getElementById('sumPreview').innerHTML =
"[最終ページ集計]\n課税対象額: -\n消費税: -\n合計: -";
    setColumnMark('name', false);
    setColumnMark('qty', false);
    setColumnMark('price', false);
    setColumnMark('amount', false);
  }

  function renderPreview(){
    // ヘッダー
    var hp = document.getElementById('headerPreview');
    hp.innerHTML =
      "年月分: " + (originalHeader.ymd || "-") + "<br>" +
      "納地: "   + (originalHeader.place || "-") + "<br>" +
      "業者名: " + (originalHeader.vendor || "-");

    // 明細
    var tbody = document.getElementById('detailTbody');
    tbody.innerHTML = "";
    var i;
    for (i = 0; i < originalRows.length; i++) {
      var r = originalRows[i];
      var tr = document.createElement('tr');

      // No（固定表示）
      var tdNo = document.createElement('td');
      tdNo.appendChild(document.createTextNode(r.no));
      tr.appendChild(tdNo);

      // 品名
      tr.appendChild(createInputCell(i, 'name', r.name));
      // 規格（最初は空。編集可だが変更マーク対象外）
      tr.appendChild(createInputCell(i, 'spec', r.spec));
      // 数量
      tr.appendChild(createInputCell(i, 'qty', r.qty));
      // 単価
      tr.appendChild(createInputCell(i, 'price', r.price));
      // 金額
      tr.appendChild(createInputCell(i, 'amount', r.amount));

      tbody.appendChild(tr);
    }

    // 集計
    var sp = document.getElementById('sumPreview');
    sp.innerHTML =
"[最終ページ集計]\n" +
"課税対象額: " + (originalSum.taxable || "-") + "\n" +
"消費税: "     + (originalSum.tax || "-") + "\n" +
"合計: "       + (originalSum.total || "-");

    // 変更マーク初期化
    updateAllColumnMarks();
  }

  function createInputCell(rowIndex, colName, value){
    var td = document.createElement('td');
    var input = document.createElement('input');
    input.type = "text";
    input.className = "row-input";
    input.value = value || "";
    input.setAttribute("data-row", String(rowIndex));
    input.setAttribute("data-col", colName);
    input.id = "cell-" + colName + "-" + rowIndex;

    input.onchange = function(){
      handleCellChange(this);
    };
    input.onkeyup = function(){
      handleCellChange(this);
    };

    td.appendChild(input);
    return td;
  }

  // ===== 規格一括入力 =====
  function applyBulkSpec(){
    var v = document.getElementById('bulkSpecText').value;
    var i;
    for (i = 0; i < originalRows.length; i++) {
      var id = "cell-spec-" + i;
      var el = document.getElementById(id);
      if (el) {
        el.value = v;
      }
    }
    // 規格は「変更マーク対象外」なので、マーク更新不要
  }

  // ===== 変更検知＆列マーク =====
  function handleCellChange(input){
    var col = input.getAttribute("data-col");
    if (col === "spec") {
      // 規格はマーク対象外
      return;
    }
    updateAllColumnMarks();
  }

  function updateAllColumnMarks(){
    updateColumnMark("name");
    updateColumnMark("qty");
    updateColumnMark("price");
    updateColumnMark("amount");
  }

  function updateColumnMark(colName){
    var changed = false;
    var i;
    for (i = 0; i < originalRows.length; i++) {
      var orig = originalRows[i] ? (originalRows[i][colName] || "") : "";
      var id = "cell-" + colName + "-" + i;
      var el = document.getElementById(id);
      if (!el) continue;
      if (el.value !== orig) {
        changed = true;
        break;
      }
    }
    setColumnMark(colName, changed);
  }

  function setColumnMark(colName, on){
    var markId = "mark-" + colName;
    var m = document.getElementById(markId);
    if (!m) return;
    m.innerHTML = on ? "*" : "";
  }
</script>

</body>
</html>