<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>pdf.js ローカル最小テスト（テキスト抽出のみ）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      font-size: 14px;
      margin: 8px;
    }
    h1{ font-size:16px; margin-bottom:4px; }
    .info{ font-size:12px; color:#555; margin-bottom:4px; }
    #log{
      font-family: "Consolas","Menlo",monospace;
      font-size: 12px;
      background:#000;
      color:#0f0;
      padding:6px;
      border-radius:4px;
      height:220px;
      overflow:auto;
      white-space:pre-wrap;
      margin-top:8px;
    }
    #textDump{
      font-family: "Consolas","Menlo",monospace;
      font-size: 12px;
      background:#fafafa;
      border:1px solid #ccc;
      padding:6px;
      margin-top:8px;
      height:260px;
      overflow:auto;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <h1>pdf.js ローカル最小テスト（テキスト抽出のみ）</h1>
  <div class="info">
    ・このHTMLと <b>pdf.min.js</b> を同じフォルダに置いてください。<br>
    ・エクスプローラからこのHTMLをダブルクリックして Edge で開きます。<br>
    ・「PDFファイル選択」で納入台帳PDFを選ぶと、テキストだけ抽出してログ表示します。<br>
    ・キャンバス描画は一切行わないので、Type3フォントのバグは無視できます。
  </div>

  <div>
    <label>PDFファイル選択：
      <input type="file" id="pdfFile" accept="application/pdf">
    </label>
  </div>

  <div id="log"></div>
  <div id="textDump"></div>

  <!-- ローカル pdf.min.js 読み込み -->
  <script src="pdf.min.js"></script>
  <script>
    // ログ出力ユーティリティ
    function log(msg){
      var el = document.getElementById('log');
      el.textContent += msg + "\n";
      el.scrollTop = el.scrollHeight;
      console.log(msg);
    }

    (function init(){
      log("=== pdf.js ローカル最小テスト開始 ===");
      if (!window.pdfjsLib){
        log("ERROR: window.pdfjsLib がありません。pdf.min.js の配置を確認してください。");
        return;
      }
      log("OK: pdf.min.js 読み込み完了。pdfjsLib.version = " + pdfjsLib.version);
      log("location.protocol = " + location.protocol + " （file:// 想定）");
      log("備考: worker は使わず、main thread だけでテキスト抽出します。");

      // worker を完全に無効化
      pdfjsLib.GlobalWorkerOptions.workerSrc = null;

      var input = document.getElementById('pdfFile');
      input.addEventListener('change', function(ev){
        var file = ev.target.files[0];
        if (file){
          runPdfTest(file);
        }
      });
    })();

    async function runPdfTest(file){
      document.getElementById('textDump').textContent = "";
      log("\n--- PDFテスト開始 ---");
      log("ファイル名: " + file.name + " / サイズ: " + file.size + " bytes");

      try{
        var arrayBuffer = await file.arrayBuffer();

        // ★ worker 無効・テキスト抽出のみ
        var loadingTask = pdfjsLib.getDocument({
          data: arrayBuffer,
          disableWorker: true
        });

        var pdf = await loadingTask.promise;
        log("ページ数: " + pdf.numPages);

        var page = await pdf.getPage(1);
        log("1ページ目取得 OK。テキスト抽出を実行します…");

        var textContent = await page.getTextContent();
        log("textContent.items.length = " + textContent.items.length);

        // 先頭 50 アイテムだけまとめて表示
        var dumpLines = [];
        for (var i = 0; i < textContent.items.length && i < 50; i++){
          var it = textContent.items[i];
          dumpLines.push(
            "[" + i + "] x=" + it.transform[4].toFixed(1) +
            " y=" + it.transform[5].toFixed(1) +
            " : \"" + it.str + "\""
          );
        }
        document.getElementById('textDump').textContent =
          dumpLines.join("\n") + "\n\n(先頭50件まで表示)";

        log("--- PDFテスト正常終了（テキスト抽出成功） ---");
      }catch(e){
        log("ERROR: PDF読み込みまたはテキスト抽出中に例外が発生しました。");
        log(String(e));
        log("--- PDFテスト異常終了 ---");
      }
    }
  </script>
</body>
</html>