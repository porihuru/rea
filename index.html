<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>pdf.js ローカル最小テスト（テキスト抽出のみ）</title>
<style>
  body { font-family: sans-serif; padding: 10px; }
  #log { background:#000; color:#0f0; padding:10px; white-space:pre-wrap; height:200px; overflow:auto; }
  #out { width:100%; height:200px; }
</style>

<!-- ★ 同じフォルダに置いた pdf.min.js を読む -->
<script src="pdf.min.js"></script>

<script>
// ------------ structuredClone ポリフィル（Edge95用） ----------------
if (typeof structuredClone !== "function") {
  window.structuredClone = (obj) => JSON.parse(JSON.stringify(obj));
}

// ------------ ログ出力 ----------------
function log(msg){
    document.getElementById("log").textContent += msg + "\n";
}

// ------------ PDF 読み込み処理 ----------------
async function handleFileSelect(evt){
    const file = evt.target.files[0];
    if(!file){ return; }

    log(`PDFテスト開始`);
    log(`ファイル名: ${file.name} / サイズ: ${file.size} bytes`);

    // File → ArrayBuffer 取得
    const arrayBuffer = await file.arrayBuffer();
    const uint8 = new Uint8Array(arrayBuffer);

    log(`arrayBuffer.byteLength = ${arrayBuffer.byteLength}`);
    log(`Uint8Array.length = ${uint8.length}`);

    try {
        // ★ worker 使わない（file:// では動かないため）
        pdfjsLib.GlobalWorkerOptions.workerSrc = "";

        // ★ Uint8Array を直接渡す（Edge95 / file:// では必須）
        const pdf = await pdfjsLib.getDocument({ data: uint8, disableWorker: true }).promise;

        log(`PDF 読み込み成功。ページ数 = ${pdf.numPages}`);

        let allText = "";

        for(let i=1;i<=pdf.numPages;i++){
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const strings = content.items.map(it => it.str).join(" ");
            allText += `--- page ${i} ---\n${strings}\n\n`;
        }

        document.getElementById("out").value = allText;
        log(`テキスト抽出完了。文字数 = ${allText.length}`);

    } catch(err){
        alert("PDF 読み込み中にエラーが発生しました。\n" + err.message);
        log("ERROR: " + err);
    }

    log(`--- PDFテスト終了 ---`);
}
</script>

</head>
<body>

<h2>pdf.js ローカル最小テスト（テキスト抽出のみ）</h2>
v2025.11.21-min / Edge95 file://想定  
<br><br>

PDFファイル選択：
<input type="file" id="pdfFile" accept="application/pdf"><br><br>

<div id="log">ログ出力エリア</div>

<textarea id="out" placeholder="ここにPDFから抽出したテキストを表示します。"></textarea>

<script>
document.getElementById("pdfFile").addEventListener("change", handleFileSelect);
</script>

</body>
</html>