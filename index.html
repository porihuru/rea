<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>pdf.js ローカル最小テスト（テキスト抽出のみ）</title>
  <style>
    body { font-family: Consolas, "Meiryo UI", monospace; font-size: 13px; }
    h1 { font-size: 16px; }
    #log {
      border: 1px solid #444;
      background: #000;
      color: #0f0;
      padding: 4px;
      white-space: pre-wrap;
      height: 260px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
<h1>pdf.js ローカル最小テスト（テキスト抽出のみ） v2025.11.21-local3 / Edge95 file://</h1>
<ol>
  <li>この HTML と <strong>pdf.min.js</strong> を同じフォルダに置く。</li>
  <li>エクスプローラからこの HTML をダブルクリックして Edge で開く。</li>
  <li>「ファイルの選択」で納入台帳PDFを選ぶ。</li>
</ol>

<p>PDFファイル選択：
  <input type="file" id="pdfFile" accept="application/pdf">
</p>

<div id="log"></div>

<!-- ★ structuredClone が無い Edge95 用 Polyfill（必ず pdf.min.js より前） -->
<script>
  if (typeof window.structuredClone !== "function") {
    window.structuredClone = function (obj) {
      // 簡易版：循環参照は不可だが、pdf.js の内部用途ならこれで十分
      return JSON.parse(JSON.stringify(obj));
    };
  }
</script>

<!-- pdf.js 本体（ローカル） -->
<script src="pdf.min.js"></script>

<script>
  function log(msg) {
    const area = document.getElementById("log");
    area.textContent += msg + "\n";
    area.scrollTop = area.scrollHeight;
  }

  log("--- pdf.js ローカル最小テスト開始 ---");
  if (window.pdfjsLib) {
    log("OK: pdf.min.js 読み込み完了。pdfjsLib.version = " + pdfjsLib.version);
  } else {
    log("NG: pdfjsLib が見つかりません。pdf.min.js の配置を確認してください。");
  }
  log("location.protocol = " + location.protocol + "  （file:// 想定）");
  log("備考: worker は使わず main thread だけでテキスト抽出します。");
  log("");

  document.getElementById("pdfFile").addEventListener("change", async (ev) => {
    const file = ev.target.files[0];
    if (!file) return;

    document.getElementById("log").textContent = "";
    log("--- PDFテスト開始 ---");
    log("ファイル名: " + file.name + " / サイズ: " + file.size + " bytes");

    try {
      const arrayBuffer = await file.arrayBuffer();

      // ★ worker を完全に無効化して FakeWorker を使わせない
      const loadingTask = pdfjsLib.getDocument({
        data: arrayBuffer,
        disableWorker: true
      });

      const pdf = await loadingTask.promise;
      log("ページ数: " + pdf.numPages);

      const page = await pdf.getPage(1);
      const textContent = await page.getTextContent();
      const text = textContent.items.map(it => it.str).join("");

      log("");
      log("--- 1ページ目テキスト抜粋 ---");
      log(text.slice(0, 500));   // 最初の500文字だけ表示
      log("");
      log("--- PDFテスト正常終了 ---");
    } catch (e) {
      log("ERROR: PDF読み込みまたはテキスト抽出中に例外が発生しました。");
      log(String(e));
      log("--- PDFテスト異常終了 ---");
      console.error(e);
    }
  });
</script>
</body>
</html>