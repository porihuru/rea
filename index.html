<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ç´å…¥å°å¸³ â†’ å“åæŠ½å‡ºï¼ˆPDFå°‚ç”¨ãƒ»æ®µéš1ï¼‰</title>

  <style>
    :root {
      color-scheme: light;
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --danger: #dc2626;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --mono: "SF Mono", Menlo, Consolas, monospace;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }
    .page {
      max-width: 1180px;
      margin: 0 auto;
      padding: 16px 16px 40px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }
    header-left-title {
      display: block;
    }
    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }
    .subtitle {
      margin: 2px 0 0;
      font-size: 11px;
      color: var(--text-sub);
    }
    .pdfjs-status {
      font-size: 11px;
      color: var(--text-sub);
      font-family: var(--mono);
      text-align: right;
    }
    .badge-version {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid var(--border);
      background: #fff;
    }
    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
    .badge-dot.ng {
      background: #ef4444;
    }

    /* Controls */
    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 16px;
      font-size: 13px;
      background: #ffffff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      color: #111827;
      box-shadow: 0 1px 1px rgba(15,23,42,0.08);
      transition: background 0.12s ease, box-shadow 0.12s ease,
        transform 0.06s ease;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 2px 5px rgba(37,99,235,0.35);
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 0 0 rgba(15,23,42,0.08);
    }
    .btn[disabled] {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }
    .btn-primary[disabled] {
      background: #9ca3af;
      border-color: transparent;
    }
    .btn-icon {
      font-size: 14px;
    }

    .note-line {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 10px;
    }

    .card {
      border-radius: 18px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.04);
      padding: 14px 16px;
      margin-bottom: 14px;
    }

    .dropzone {
      margin-top: 10px;
      border-radius: 16px;
      border: 1px dashed #cbd5f5;
      background: #f9fbff;
      padding: 22px 18px;
      text-align: center;
      font-size: 13px;
      color: var(--text-sub);
    }
    .dropzone strong {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      color: #111827;
    }

    .status-line {
      font-size: 13px;
      margin-bottom: 6px;
    }
    .status-ok {
      color: #16a34a;
    }
    .status-ng {
      color: var(--danger);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
      font-size: 13px;
    }
    .info-item label {
      display: block;
      font-size: 10px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--text-sub);
      margin-bottom: 2px;
    }
    .info-item .value {
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .amount-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
      margin-top: 10px;
      font-size: 13px;
    }
    .amount-pill {
      border-radius: 999px;
      padding: 4px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
    }
    .amount-pill span.label {
      font-size: 11px;
      color: var(--text-sub);
    }
    .amount-pill span.num {
      font-family: var(--mono);
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title small {
      font-size: 11px;
      font-weight: 400;
      color: var(--text-sub);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
    }
    thead {
      background: #f3f4f6;
    }
    th, td {
      padding: 6px 10px;
      border-bottom: 1px solid #e5e7eb;
    }
    th {
      text-align: left;
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) td {
      background: #fafbff;
    }
    td.no-col {
      width: 68px;
      white-space: nowrap;
      font-family: var(--mono);
      text-align: center;
    }
    td.name-col {
      word-break: break-all;
    }
    .empty-msg {
      font-size: 12px;
      color: var(--text-sub);
      padding: 10px;
    }

    .log {
      font-size: 11px;
      color: var(--text-sub);
      font-family: var(--mono);
      margin-top: 6px;
      max-height: 120px;
      overflow: auto;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      padding: 6px 8px;
      white-space: pre-wrap;
    }

    @media (max-width: 768px) {
      .info-grid {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
      .amount-grid {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
      .page {
        padding: 10px 10px 32px;
      }
      h1 {
        font-size: 17px;
      }
    }
  </style>

  <!-- ãƒ­ãƒ¼ã‚«ãƒ«é…ç½®ã—ãŸ pdf.min.js ã‚’èª­ã¿è¾¼ã¿ -->
  <script src="pdf.min.js"></script>
</head>
<body>
<div class="page">
  <header>
    <div>
      <h1>ç´å…¥å°å¸³ â†’ å“åæŠ½å‡ºï¼ˆPDFå°‚ç”¨ãƒ»æ®µéš1ï¼‰</h1>
      <p class="subtitle">å“åè¡Œã‚’PDFã‹ã‚‰æŠ½å‡ºã—ã€ã€ŒNoï¼‹å“åï¼ˆ1è¡Œï¼‰ã€ä¸€è¦§ã‚’ä½œæˆã—ã¾ã™ã€‚æ•°é‡ãƒ»å˜ä¾¡ãƒ»é‡‘é¡ãƒ»è«‹æ±‚æ›¸PDFä½œæˆãƒ»Excelé€£æºã¯ã¾ã è¡Œã„ã¾ã›ã‚“ã€‚</p>
    </div>
    <div class="pdfjs-status">
      <div class="badge-version" id="pdfjsVersionBadge">
        <span class="badge-dot ng" id="pdfjsDot"></span>
        <span id="pdfjsVersionText">PDF.js - / local?</span>
      </div>
    </div>
  </header>

  <div class="toolbar">
    <label class="btn btn-primary">
      <span class="btn-icon">ğŸ“„</span>
      <span>PDFã‚’é¸æŠ</span>
      <input type="file" id="pdfInput" accept="application/pdf" style="display:none" />
    </label>
  </div>
  <div class="note-line">
    â€» ç´å…¥å°å¸³PDFã‚’1ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘èª­ã¿è¾¼ã¿ã¾ã™ï¼ˆ<code>pdf.min.js</code> / <code>pdf.worker.min.js</code> ã¯åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ï¼‰ã€‚
  </div>

  <!-- æ¦‚è¦ã‚«ãƒ¼ãƒ‰ -->
  <section class="card" id="summaryCard">
    <div id="statusLine" class="status-line status-ng">PDFãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>

    <div class="info-grid">
      <div class="info-item">
        <label>PDFãƒ•ã‚¡ã‚¤ãƒ«å</label>
        <div class="value" id="infoFileName">-</div>
      </div>
      <div class="info-item">
        <label>ãƒšãƒ¼ã‚¸æ•°</label>
        <div class="value" id="infoPages">-</div>
      </div>
      <div class="info-item">
        <label>ç´åœ°</label>
        <div class="value" id="infoPlace">-</div>
      </div>
      <div class="info-item">
        <label>æ¥­è€…å</label>
        <div class="value" id="infoVendor">-</div>
      </div>
    </div>

    <div class="amount-grid">
      <div class="amount-pill">
        <span class="label">èª²ç¨å¯¾è±¡é¡ï¼ˆåŸæœ¬ï¼‰</span>
        <span class="num" id="amtTaxable">-</span>
      </div>
      <div class="amount-pill">
        <span class="label">æ¶ˆè²»ç¨ï¼ˆåŸæœ¬ï¼‰</span>
        <span class="num" id="amtTax">-</span>
      </div>
      <div class="amount-pill">
        <span class="label">åˆè¨ˆï¼ˆåŸæœ¬ï¼‰</span>
        <span class="num" id="amtTotal">-</span>
      </div>
    </div>

    <div class="dropzone" id="dropzone">
      <strong>ã“ã“ã«ç´å…¥å°å¸³PDFï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</strong>
      <div>ã¾ãŸã¯ä¸Šã®ã€ŒPDFã‚’é¸æŠã€ãƒœã‚¿ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚</div>
    </div>
  </section>

  <!-- æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <section class="card">
    <div class="section-title">
      æ˜ç´°ï¼ˆNo / å“å 1è¡Œï¼‰
      <small id="rowsSummary">0ä»¶</small>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
        <tr>
          <th style="width:70px;">No</th>
          <th>å“åï¼ˆPDFã‹ã‚‰æŠ½å‡ºã—1è¡Œã«æ•´å½¢ï¼‰</th>
        </tr>
        </thead>
        <tbody id="rowsBody">
        <tr><td colspan="2" class="empty-msg">PDFãŒæœªè§£æã§ã™ã€‚</td></tr>
        </tbody>
      </table>
    </div>
    <div class="log" id="logArea"></div>
  </section>
</div>

<script>
  // --- PDF.js åˆæœŸåŒ– ---
  (function initPdfJs() {
    const badgeText = document.getElementById("pdfjsVersionText");
    const dot = document.getElementById("pdfjsDot");
    try {
      if (!window.pdfjsLib) {
        badgeText.textContent = "PDF.js NG / not loaded";
        dot.classList.add("ng");
        return;
      }
      // worker ã‚’åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰
      pdfjsLib.GlobalWorkerOptions.workerSrc = "pdf.worker.min.js";

      const v = pdfjsLib.version || "unknown";
      badgeText.textContent = "PDF.js " + v + " / local";
      dot.classList.remove("ng");
    } catch (e) {
      badgeText.textContent = "PDF.js error";
      dot.classList.add("ng");
      console.error(e);
    }
  })();

  const pdfInput = document.getElementById("pdfInput");
  const statusLine = document.getElementById("statusLine");
  const infoFileName = document.getElementById("infoFileName");
  const infoPages = document.getElementById("infoPages");
  const infoPlace = document.getElementById("infoPlace");
  const infoVendor = document.getElementById("infoVendor");
  const amtTaxable = document.getElementById("amtTaxable");
  const amtTax = document.getElementById("amtTax");
  const amtTotal = document.getElementById("amtTotal");
  const rowsBody = document.getElementById("rowsBody");
  const rowsSummary = document.getElementById("rowsSummary");
  const logArea = document.getElementById("logArea");
  const dropzone = document.getElementById("dropzone");

  // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
  function formatYen(n) {
    if (n == null || n === "" || isNaN(Number(String(n).replace(/,/g, "")))) return "-";
    const num = Number(String(n).replace(/,/g, ""));
    return "Â¥" + num.toLocaleString("ja-JP");
  }

  function appendLog(msg) {
    const now = new Date();
    const time = now.toTimeString().slice(0, 8);
    logArea.textContent += "[" + time + "] " + msg + "\n";
    logArea.scrollTop = logArea.scrollHeight;
  }

  // pdf.js ã® textContent.items ã‹ã‚‰ã€ãŠãŠã–ã£ã±ã«ã€Œè¡Œã€ã‚’ä½œã‚‹
  function buildLines(items) {
    // y é™é †ï¼ˆç´™ã®ä¸Šã‹ã‚‰ï¼‰ã€åŒã˜è¡Œå†…ã§ã¯ x æ˜‡é †
    const sorted = items.slice().sort((a, b) => {
      const ay = a.transform[5], by = b.transform[5];
      if (Math.abs(by - ay) > 2) return by - ay; // ä¸Šã‹ã‚‰ä¸‹ã¸
      return a.transform[4] - b.transform[4]; // å·¦ã‹ã‚‰å³ã¸
    });

    const lines = [];
    let currentY = null;
    let row = [];

    const Y_THRESHOLD = 2.5; // åŒä¸€è¡Œã¨ã¿ãªã™ç¸¦æ–¹å‘ã®è¨±å®¹å·®

    for (const it of sorted) {
      const y = it.transform[5];
      if (currentY === null) {
        currentY = y;
        row.push(it);
      } else if (Math.abs(y - currentY) <= Y_THRESHOLD) {
        row.push(it);
      } else {
        if (row.length) {
          row.sort((a, b) => a.transform[4] - b.transform[4]);
          lines.push(row.map(t => t.str).join(" ").replace(/\s+/g, " ").trim());
        }
        row = [it];
        currentY = y;
      }
    }
    if (row.length) {
      row.sort((a, b) => a.transform[4] - b.transform[4]);
      lines.push(row.map(t => t.str).join(" ").replace(/\s+/g, " ").trim());
    }
    return lines.filter(s => s && s.trim().length > 0);
  }

  // å“åã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼šã–ã£ãã‚Šã€Œå˜ä½ï¼‹æ•°å­—ã€ãªã©ã‚’å‰Šã‚‹
  function cleanupName(raw) {
    if (!raw) return "";
    let s = raw.trim();

    // å…ˆé ­ã®å˜ä½ï¼ˆBG, KG, PC, EA, CN ç­‰ï¼‰ã¨ * ã‚’å‰Šé™¤
    s = s.replace(/^(BG|KG|PC|EA|CN|JB|LB)\s*\*?\s*/i, "");

    // å…ˆé ­ã®é€£ç¶šã—ãŸæ•°å€¤ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ï¼ˆ2,450.00 1.00 2.00 ãªã©ï¼‰
    s = s.replace(/^(([\d,.]+|[\d]+\/[\d]+)\s+)+/, "");

    // è¡Œæœ«å´ã®ã€Œæ•°é‡ãƒ»å˜ä¾¡ãƒ»é‡‘é¡ã€ã£ã½ã„é€£ç¶šæ•°å­—ã‚’å¤§ãã‚ã«å‰Šé™¤
    // ï¼ˆæ—¥æœ¬èªãŒä¸€åº¦å‡ºã¦ã‹ã‚‰ã€æœ€å¾Œã®é€£ç¶šæ•°å­—ç¾¤ã®æ‰‹å‰ã¾ã§ã‚’æ®‹ã™ï¼‰
    const m = s.match(/^(.*?)(\s+[\d,]+\.\d{2}.*)$/);
    if (m) {
      s = m[1];
    } else {
      // ã†ã¾ãåˆ‡ã‚Œãªã‹ã£ãŸå ´åˆã¯ã€æœ«å°¾ã®ã€Œæ•°å­—ã ã‘ã®ã‹ãŸã¾ã‚Šã€ã‚’1ã€œ2å€‹è½ã¨ã™
      s = s.replace(/(\s+[\d,]+(?:\.\d+)?){1,2}\s*$/, "");
    }

    // ã¾ã æ•°å­—ã ã‚‰ã‘ãªã‚‰ã€ãã®ã¾ã¾è¿”ã™ï¼ˆç„¡ç†ã«å‰Šã‚‰ãªã„ï¼‰
    s = s.replace(/\s+/g, " ").trim();
    return s || raw.trim();
  }

  // è¡Œé‡‘é¡åˆè¨ˆã‚„æœ€çµ‚åˆè¨ˆã®è¡Œã‹ã‚‰ã€Œä¸€ç•ªå³ç«¯ã®æ•°å­—ã€ã‚’æ‹¾ã†
  function pickLastNumber(line) {
    const matches = [...line.matchAll(/([\d,]+(?:\.\d+)?)/g)];
    if (!matches.length) return null;
    return matches[matches.length - 1][1];
  }

  // --- PDF è§£ææœ¬ä½“ ---
  async function analyzePdfFile(file) {
    statusLine.textContent = "PDFã‚’è§£æä¸­ã§ã™...";
    statusLine.classList.remove("status-ok");
    statusLine.classList.remove("status-ng");

    appendLog("è§£æé–‹å§‹: " + file.name);

    const arrayBuf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;

    const result = {
      fileName: file.name,
      pages: pdf.numPages,
      place: "",
      vendor: "",
      taxable: null,
      tax: null,
      total: null,
      rows: []
    };

    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      const page = await pdf.getPage(pageNum);
      const textContent = await page.getTextContent();
      const lines = buildLines(textContent.items);

      appendLog(`ãƒšãƒ¼ã‚¸${pageNum}: è¡Œæ•° ${lines.length}`);

      // ç´åœ°ãƒ»æ¥­è€…åï¼ˆæœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‚ã®ã‚’æ¡ç”¨ï¼‰
      for (const line of lines) {
        if (!result.place && /ç´åœ°[:ï¼š]/.test(line)) {
          const m = line.match(/ç´åœ°[:ï¼š]\s*(.+?)(?:\s+æ¥­è€…å|$)/);
          result.place = (m ? m[1] : line.replace(/.*ç´åœ°[:ï¼š]\s*/, "")).trim();
        }
        if (!result.vendor && /æ¥­è€…å[:ï¼š]/.test(line)) {
          const m = line.match(/æ¥­è€…å[:ï¼š]\s*(.+)$/);
          result.vendor = (m ? m[1] : line.replace(/.*æ¥­è€…å[:ï¼š]\s*/, "")).trim();
        }
      }

      // è¡Œæ˜ç´°
      const headerIndex = lines.findIndex(
        l => /No\b/.test(l) && /å“\s*å/.test(l)
      );
      if (headerIndex !== -1) {
        appendLog(`ãƒšãƒ¼ã‚¸${pageNum}: æ˜ç´°ãƒ˜ãƒƒãƒ€ãƒ¼æ¤œå‡º index=${headerIndex}`);
        let currentRow = null;
        let started = false;
        for (let i = headerIndex + 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          // ãƒšãƒ¼ã‚¸å†…ã®åˆ¥ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„ã€Œè¡Œé‡‘é¡åˆè¨ˆã€ã€Œè«‹æ±‚æ›¸åˆè¨ˆã€ã§çµ‚äº†
          if (/No\b/.test(line) && /å“\s*å/.test(line)) {
            currentRow = null;
            started = false;
            continue;
          }
          if (/è¡Œ\s*é‡‘é¡\s*åˆè¨ˆ/.test(line) || /è«‹æ±‚æ›¸åˆè¨ˆ/.test(line)) {
            appendLog(`ãƒšãƒ¼ã‚¸${pageNum}: æ˜ç´°çµ‚ç«¯è¡Œ: ${line}`);
            break;
          }

          const m = line.match(/^(\d{4})\s+(.+)$/);
          if (m) {
            // æ–°ã—ã„æ˜ç´°è¡Œ
            started = true;
            currentRow = {
              no: m[1],
              nameRaw: m[2].trim()
            };
            result.rows.push(currentRow);
          } else if (started && currentRow) {
            // å“åã®æŠ˜ã‚Šè¿”ã—ç­‰ã‚’å¾Œã‚ã«é€£çµï¼ˆåˆ¥ãƒ˜ãƒƒãƒ€ãƒ¼ã£ã½ã„è¡Œã¯é™¤å¤–ï¼‰
            if (/^ç´\s*å…¥\s*å°\s*å¸³/.test(line)) continue;
            if (/^ç´åœ°[:ï¼š]/.test(line) || /^æ¥­è€…å[:ï¼š]/.test(line)) continue;
            currentRow.nameRaw += " " + line;
          }
        }
      }

      // æœ€çµ‚ãƒšãƒ¼ã‚¸ã®é‡‘é¡ç³»ã¯ã€Œå¾Œã«å‡ºãŸã‚‚ã®å„ªå…ˆã€ã§ã©ã‚“ã©ã‚“ä¸Šæ›¸ã
      for (const line of lines) {
        if (/èª²ç¨å¯¾è±¡é¡/.test(line)) {
          const n = pickLastNumber(line);
          if (n != null) {
            result.taxable = n;
          }
        }
        if (/æ¶ˆè²»ç¨/.test(line)) {
          const n = pickLastNumber(line);
          if (n != null) {
            result.tax = n;
          }
        }
        // ã€Œè«‹æ±‚æ›¸åˆè¨ˆã€ã€Œåˆè¨ˆé‡‘é¡ã€ãªã©ã‚’æƒ³å®š
        if (/åˆè¨ˆ/.test(line) && !/è¡Œ\s*é‡‘é¡\s*åˆè¨ˆ/.test(line)) {
          if (/è«‹æ±‚æ›¸/.test(line) || /åˆè¨ˆ\s*[ï¼ˆ(]/.test(line)) {
            const n = pickLastNumber(line);
            if (n != null) {
              result.total = n;
            }
          }
        }
      }
    }

    // å“åã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    for (const row of result.rows) {
      row.name = cleanupName(row.nameRaw);
    }

    return result;
  }

  function renderResult(result) {
    infoFileName.textContent = result.fileName || "-";
    infoPages.textContent = result.pages || "-";
    infoPlace.textContent = result.place || "-";
    infoVendor.textContent = result.vendor || "-";

    amtTaxable.textContent = result.taxable ? formatYen(result.taxable) : "-";
    amtTax.textContent = result.tax ? formatYen(result.tax) : "-";
    amtTotal.textContent = result.total ? formatYen(result.total) : "-";

    rowsBody.innerHTML = "";
    if (!result.rows.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 2;
      td.className = "empty-msg";
      td.textContent =
        "å“åè¡Œã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚PDFã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒç‰¹æ®Šãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
      tr.appendChild(td);
      rowsBody.appendChild(tr);
    } else {
      for (const row of result.rows) {
        const tr = document.createElement("tr");
        const tdNo = document.createElement("td");
        tdNo.className = "no-col";
        tdNo.textContent = row.no;
        const tdName = document.createElement("td");
        tdName.className = "name-col";
        tdName.textContent = row.name;
        tr.appendChild(tdNo);
        tr.appendChild(tdName);
        rowsBody.appendChild(tr);
      }
    }
    rowsSummary.textContent = result.rows.length + "ä»¶";

    statusLine.textContent = "OK: è§£æå®Œäº†ã—ã¾ã—ãŸã€‚";
    statusLine.classList.add("status-ok");
  }

  // --- ã‚¤ãƒ™ãƒ³ãƒˆ ---
  pdfInput.addEventListener("change", async (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    try {
      const result = await analyzePdfFile(file);
      renderResult(result);
      appendLog("è§£æå®Œäº†: æ˜ç´° " + result.rows.length + "ä»¶");
    } catch (e) {
      console.error(e);
      statusLine.textContent = "PDFè§£æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      statusLine.classList.add("status-ng");
      appendLog("ERROR: " + e.message);
    }
  });

  // D&D ã§ã‚‚æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«
  ;["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
    dropzone.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
    });
  });
  ;["dragenter", "dragover"].forEach(eventName => {
    dropzone.addEventListener(eventName, () => {
      dropzone.style.background = "#eef2ff";
    });
  });
  ;["dragleave", "drop"].forEach(eventName => {
    dropzone.addEventListener(eventName, () => {
      dropzone.style.background = "#f9fbff";
    });
  });
  dropzone.addEventListener("drop", async (e) => {
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file) return;
    pdfInput.files = e.dataTransfer.files; // ä¸€å¿œåŒæœŸ
    try {
      const result = await analyzePdfFile(file);
      renderResult(result);
      appendLog("è§£æå®Œäº†(D&D): æ˜ç´° " + result.rows.length + "ä»¶");
    } catch (err) {
      console.error(err);
      statusLine.textContent = "PDFè§£æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      statusLine.classList.add("status-ng");
      appendLog("ERROR: " + err.message);
    }
  });
</script>
</body>
</html>
